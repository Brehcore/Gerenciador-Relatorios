<section class="checklist-page page">
  <div class="container">
  <h1 class="page-title">Checklist de Riscos Ocupacionais</h1>

    <fieldset class="aep-header">
      <legend>Dados da Inspe√ß√£o</legend>
      <div class="fields">
        <div class="field-row">
          <label for="aepCompany" class="field-label">Empresa Cliente:</label>
          <div class="field-input">
            <div class="inline-controls">
              <div class="search-input-wrapper">
                <input type="text" class="form-control" placeholder="üîç Digitar para buscar..." [(ngModel)]="companySearchTerm" [ngModelOptions]="{standalone: true}" (ngModelChange)="filterCompanies()" (focus)="onCompanyFocus()" (blur)="onCompanyBlur()" title="Digite o nome ou CNPJ da empresa" autocomplete="off" />
                <button *ngIf="companySearchTerm" type="button" class="clear-btn" (click)="clearCompanySelection()" aria-label="Limpar pesquisa">‚úï</button>
                <div class="company-suggestions" *ngIf="filteredCompanies.length && (companySearchTerm || showCompanySuggestions)">
                  <ul>
                    <li *ngFor="let s of filteredCompanies" (mousedown)="selectCompanyFromSuggestion(s); $event.preventDefault()" (click)="$event.preventDefault()">
                      <span class="initials">{{ getCompanyInitials(s.name || s.razaoSocial || s.nomeFantasia) }}</span>
                      <span class="name">{{ s.name }}</span>
                      <span class="cnpj">{{ s.cnpj ? (' - ' + s.cnpj) : '' }}</span>
                    </li>
                  </ul>
                </div>
              </div>
              <select id="aepCompany" class="form-select company-hidden-select" [(ngModel)]="company" (change)="onCompanyChange(company)" title="Empresa">
                <option value="">{{ loadingCompanies ? 'Carregando...' : 'Selecione...' }}</option>
                <option *ngFor="let c of filteredCompanies" [value]="c.id || c.name" [attr.data-cnpj]="c.cnpj">{{ c.name }}</option>
              </select>
            </div>
          </div>
        </div>

        <!-- fun√ß√£o: o dropdown foi movido para ficar abaixo do bot√£o 'Adicionar fun√ß√£o' -->

        <div class="field-row half cnpj-row">
          <label for="aepCnpj" class="field-label">CNPJ:</label>
          <div class="field-input"><input id="aepCnpj" class="form-control" title="CNPJ da empresa" [value]="formatCnpj(cnpj)" readonly /></div>
        </div>

        <div class="field-row">
          <label for="aepUnidade" class="field-label">Unidade (opcional):</label>
          <div class="field-input">
            <select id="aepUnidade" class="form-select" title="Unidade (opcional)" [(ngModel)]="unidade">
              <option value="">{{ units.length ? 'Selecione a unidade...' : 'Nenhuma unidade dispon√≠vel' }}</option>
              <option *ngFor="let u of units" [value]="u.id || u.name || u">{{ u.name || u }}</option>
            </select>
          </div>
        </div>

        <div class="field-row">
          <label for="aepSetor" class="field-label">Setor (opcional):</label>
          <div class="field-input">
            <select id="aepSetor" class="form-select" title="Setor (opcional)" [(ngModel)]="setor">
              <option value="">{{ sectors.length ? 'Selecione o setor...' : 'Nenhum setor dispon√≠vel' }}</option>
              <option *ngFor="let s of sectors" [value]="s.id || s.name || s">{{ s.name || s }}</option>
            </select>
          </div>
        </div>

        <div class="field-row date-row">
          <label for="aepDate" class="field-label">Data da Inspe√ß√£o:</label>
            <div class="field-input"><input id="aepDate" class="form-control date-input" [(ngModel)]="date" type="date" title="Data" /></div>
        </div>

        <div class="field-row">
          <label for="checklistTitle" class="field-label">T√≠tulo do Relat√≥rio (opcional):</label>
          <div class="field-input">
            <div class="input-with-counter">
              <input id="checklistTitle" class="form-control" [(ngModel)]="title" type="text" placeholder="Ex: Inspe√ß√£o ABC - Setor X" title="T√≠tulo do relat√≥rio" [maxlength]="charLimits.title" />
              <span class="char-counter">{{ title.length }}/{{ charLimits.title }}</span>
            </div>
          </div>
        </div>
        
      </div>
    </fieldset>

    <fieldset class="aep-header">
    <legend>Dados do Avaliador</legend>
    <div class="fields">
        <div class="field-row">
          <label for="aepEvaluator" class="field-label">Avaliador:</label>
          <div class="field-input">
            <div class="input-with-counter">
              <input id="aepEvaluator" class="form-control" title="Nome do avaliador" [(ngModel)]="evaluator" placeholder="Nome do avaliador" [maxlength]="charLimits.evaluator" />
              <span class="char-counter">{{ evaluator.length }}/{{ charLimits.evaluator }}</span>
            </div>
          </div>
        </div>

        <div class="field-row">
          <label for="aepSigla" class="field-label">Sigla do Conselho:</label>
          <div class="field-input">
            <div class="input-with-counter">
              <input id="aepSigla" class="form-control" [(ngModel)]="sigla" title="Sigla do Conselho" placeholder="Sigla (ex: TST)" [maxlength]="charLimits.sigla" />
              <span class="char-counter">{{ sigla.length }}/{{ charLimits.sigla }}</span>
            </div>
          </div>
        </div>

        <div class="field-row">
          <label for="aepRegistro" class="field-label">Registro no Conselho:</label>
          <div class="field-input">
            <div class="input-with-counter">
              <input id="aepRegistro" class="form-control" [(ngModel)]="registro" title="Registro" placeholder="N√∫mero do registro" [maxlength]="charLimits.registro" />
              <span class="char-counter">{{ registro.length }}/{{ charLimits.registro }}</span>
            </div>
          </div>
        </div>

        <div class="field-row">
          <label for="aepEspecialidade" class="field-label">Especialidade:</label>
          <div class="field-input">
            <div class="input-with-counter">
              <input id="aepEspecialidade" class="form-control" [(ngModel)]="especialidade" title="Especialidade" placeholder="Ex: T√©cnico de Seguran√ßa do Trabalho" [maxlength]="charLimits.especialidade" />
              <span class="char-counter">{{ especialidade.length }}/{{ charLimits.especialidade }}</span>
            </div>
          </div>
        </div>

      </div>
    </fieldset>

    <div *ngIf="showRiskTable" class="checklist-table">
  <div class="selected-func" *ngIf="selectedFunction">Fun√ß√£o selecionada: {{ selectedFunction }}</div>
      <div class="table-wrapper">
        <table class="aep-table compact">
          <thead>
            <tr>
              <th class="col-sel">Sel</th>
              <th class="col-risk">RISCO</th>
              <th>FATOR DE RISCO</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let it of items; let i = index">
              <td class="chk">
                <span class="chk-num">{{ it.code }}</span>
                <input type="checkbox" [id]="'chk_'+i" [checked]="it.checked" title="Selecionar fator de risco {{it.code}}" aria-label="Selecionar fator de risco {{it.code}}" (change)="toggle(it,$event)" />
              </td>
              <td class="tipo">{{ it.risco }}</td>
              <td class="fator"><label [for]="'chk_'+i">{{ it.fator }}</label></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="actions mt-16">
      <div class="function-actions">
        <button type="button" class="btn-primary" (click)="showFunctionSelector = !showFunctionSelector">Adicionar Fun√ß√£o ao Relat√≥rio</button>
      </div>

      <!-- Evaluated functions list (each function has its own checklist) -->
      <div class="evaluated-list mt-12" *ngIf="evaluatedFunctions.length">
        <div *ngFor="let ef of evaluatedFunctions; index as idx" class="evaluated-card card mb-8">
          <div class="card-header">
            <h4>{{ ef.functionName }}</h4>
            <div class="card-actions">
              <button class="btn-ghost" type="button" (click)="ef.expanded = !ef.expanded" [attr.aria-expanded]="ef.expanded" [attr.title]="ef.expanded ? 'Fechar lista de riscos' : 'Abrir lista de riscos'">
                <span class="btn-ico">{{ ef.expanded ? '‚ñ¥' : '‚ñæ' }}</span>
                <span class="btn-label">{{ ef.expanded ? 'Fechar' : 'Abrir' }}</span>
              </button>
              <button class="btn-danger" type="button" (click)="confirmRemove(idx)" title="Remover fun√ß√£o do relat√≥rio">Remover</button>
            </div>
          </div>
          <div class="card-body" *ngIf="ef.expanded">
            <div class="risk-groups">
              <div *ngFor="let g of riskGroups" class="risk-group">
                <div class="group-title">{{ g.key }}</div>
                <div class="group-list">
                  <label *ngFor="let it of g.value; trackBy: trackByRisk" class="risk-item">
                    <input type="checkbox" [checked]="ef.selectedRiskCodes.includes(it.code)" (change)="toggleRisk(ef, it.code, $event)" />
                    <span class="risk-code">{{ it.code }}</span>
                    <span class="risk-factor">{{ it.fator }}</span>
                  </label>
                </div>
              </div>
            </div>
          </div>
          <!-- Bot√£o replicado: permite adicionar outra fun√ß√£o logo abaixo da tabela desta fun√ß√£o avaliada -->
          <div class="card-footer" *ngIf="ef.expanded">
            <button type="button" class="btn-primary btn-add-below" (click)="showFunctionSelector = true">Adicionar Fun√ß√£o ao Relat√≥rio</button>
          </div>
        </div>
      </div>

      <!-- Function selector dropdown - aparece DEPOIS das fun√ß√µes j√° adicionadas -->
      <div *ngIf="showFunctionSelector" class="function-selector">
        <label class="sr-only">Fun√ß√£o</label>
        <div class="selector-row">
          <select class="form-select" title="Fun√ß√£o" [(ngModel)]="selectedFunction">
            <option value="">Selecione a fun√ß√£o...</option>
            <option *ngFor="let f of jobRoles.length ? jobRoles : companyFunctions" [value]="f.name || f">{{ f.name || f }}</option>
          </select>
          <button type="button" class="btn-primary btn-confirm" (click)="addFunctionToReport()">Adicionar</button>
          <button type="button" class="btn-link" (click)="showNewRoleInput = !showNewRoleInput">(+ Nova Fun√ß√£o)</button>
        </div>
        <div *ngIf="showNewRoleInput" class="new-role-row mt-8">
          <input class="form-control" placeholder="Nome da nova fun√ß√£o" [(ngModel)]="newRoleName" (keyup.enter)="createJobRole()" (keyup.esc)="showNewRoleInput=false; newRoleName=''" />
          <div class="new-role-actions">
            <button class="btn-primary" type="button" (click)="createJobRole()">Salvar</button>
            <button class="btn-cancel" type="button" aria-label="Cancelar" title="Cancelar" (click)="showNewRoleInput=false; newRoleName=''">√ó</button>
          </div>
        </div>
      </div>

      <div class="signature-area">
        <button class="btn-primary" type="button" (click)="finalizeReport()">Finalizar Relat√≥rio</button>
      </div>
    </div>

    <!-- Modal de assinatura: modo somente t√©cnico (carrega automaticamente o nome do t√©cnico logado) -->
    <app-signature-modal #sigModal (confirmSignatures)="onTechSignature($event)" [techOnly]="true"></app-signature-modal>

    <!-- Confirma√ß√£o inline ao finalizar relat√≥rio -->
    <div *ngIf="showFinalizeConfirm" class="overlay">
      <div class="confirm-card">
        <h3>Deseja assinar digitalmente este documento?</h3>
        <p>Este checklist pode ser salvo sem assinatura para uso em campo.</p>
        <p><strong>‚ö†Ô∏è Importante:</strong> Ap√≥s assinado digitalmente, este documento <strong>n√£o poder√° ser editado</strong> e ser√° considerado finalizado.</p>
        <div class="confirm-actions">
          <button type="button" class="btn-primary" (click)="onConfirmSign()">Sim, Assinar</button>
          <button type="button" class="btn-ghost" (click)="onConfirmNoSign()">N√£o, Salvar sem Assinar</button>
          <button type="button" class="btn-link close-x" (click)="showFinalizeConfirm=false" aria-label="Fechar">√ó</button>
        </div>
      </div>
    </div>
  </div>
</section>
