<section class="aep-page page">
  <div class="container">
    <h1 class="page-title">Avalia√ß√£o Ergon√¥mica Preliminar (AEP)</h1>
    <form [formGroup]="form" class="aep-form" (ngSubmit)="submit()">
      <fieldset class="aep-header">
        <legend>Dados da Avalia√ß√£o</legend>
        <div class="fields">
          <div class="field-row">
            <label for="aepCompany" class="field-label">Empresa Cliente:</label>
            <div class="field-input">
              <div class="search-input-wrapper">
                <input type="text" class="form-control" placeholder="üîç Digitar para buscar..." [(ngModel)]="companySearchTerm" [ngModelOptions]="{standalone: true}" (ngModelChange)="filterCompanies()" (focus)="onCompanyFocus()" (blur)="onCompanyBlur()" title="Digite o nome ou CNPJ da empresa" autocomplete="off" />
                <button *ngIf="companySearchTerm" type="button" class="clear-btn" (click)="clearCompanySelection()" aria-label="Limpar pesquisa">‚úï</button>
                <div class="company-suggestions" *ngIf="filteredCompanies.length && (companySearchTerm || showCompanySuggestions)">
                  <ul>
                    <li *ngFor="let s of filteredCompanies" (mousedown)="selectCompanyFromSuggestion(s); $event.preventDefault()" (click)="$event.preventDefault()">
                      <span class="initials">{{ getCompanyInitials(s.name || s.razaoSocial || s.nomeFantasia) }}</span>
                      <span class="name">{{ s.name || s.razaoSocial || s.nomeFantasia }}</span>
                      <span class="cnpj">{{ s.cnpj ? (' - ' + (s.cnpj | cnpjFormat)) : '' }}</span>
                    </li>
                  </ul>
                </div>
              </div>
              <select id="aepCompany" formControlName="company" class="form-select company-hidden-select" title="Empresa">
                <option value="">{{ loadingCompanies ? 'Carregando...' : 'Selecione...' }}</option>
                <option *ngFor="let c of filteredCompanies" [value]="c.id || c.name" [attr.data-cnpj]="c.cnpj">{{c.name}}</option>
              </select>
            </div>
          </div>

          <div class="field-row">
            <label for="aepCnpj" class="field-label">CNPJ:</label>
            <div class="field-input">
              <input id="aepCnpj" formControlName="cnpj" class="form-control" readonly title="CNPJ" />
            </div>
          </div>

          <div class="section-separator" aria-hidden="true"></div>

          <div class="field-row">
            <label for="aepEvaluator" class="field-label">Avaliador:</label>
            <div class="field-input">
              <input id="aepEvaluator" formControlName="evaluator" class="form-control" title="Avaliador" placeholder="Nome do avaliador" />
            </div>
          </div>

          <div class="field-row">
            <label for="aepSigla" class="field-label">Sigla do Conselho:</label>
            <div class="field-input">
              <input id="aepSigla" formControlName="sigla" class="form-control" title="Sigla do Conselho" placeholder="Sigla (ex: TST)" />
            </div>
          </div>

          <div class="field-row">
            <label for="aepRegistro" class="field-label">Registro no Conselho:</label>
            <div class="field-input">
              <input id="aepRegistro" formControlName="registro" class="form-control" title="Registro" placeholder="N√∫mero do registro" />
            </div>
          </div>

          <div class="field-row">
            <label for="aepEspecialidade" class="field-label">Especialidade:</label>
            <div class="field-input">
              <input id="aepEspecialidade" formControlName="especialidade" class="form-control" title="Especialidade" placeholder="Ex: T√©cnico de Seguran√ßa do Trabalho" />
            </div>
          </div>

          <div class="field-row">
            <label for="aepDate" class="field-label">Data da Avalia√ß√£o:</label>
            <div class="field-input">
              <input id="aepDate" formControlName="date" class="form-control" type="date" title="Data" />
            </div>
          </div>

          <div class="field-row">
            <label for="aepFunction" class="field-label">Fun√ß√£o Avaliada:</label>
            <div class="field-input">
              <input id="aepFunction" formControlName="funcao" class="form-control" placeholder="Ex: Operador de Produ√ß√£o" title="Fun√ß√£o" />
            </div>
          </div>
        </div>
      </fieldset>

      <!-- Assinatura: informativo apenas ‚Äî assinatura ser√° realizada externamente por fisioterapeuta (ICP-Brasil/Gov). -->
      <div class="aep-signature-note">
        <strong>Assinatura:</strong>
        <p>A assinatura deste documento deve ser realizada por um fisioterapeuta (assinatura externa v√°lida via ICP-Brasil / Governo). N√£o coletamos assinatura eletr√¥nica aqui. O documento pode ser emitido imediatamente e permanecer√° edit√°vel.</p>
      </div>

      <fieldset class="aep-risks">
        <legend>Riscos Identificados por Fun√ß√£o</legend>
        <div class="table-wrapper">
          <table class="aep-table">
            <thead>
              <tr>
                <th class="col-sel">Sel</th>
                <th class="col-risk">Risco</th>
                <th>Fator de Risco</th>
              </tr>
            </thead>
            <tbody id="aepRisks">
              <tr *ngFor="let rf of riskFactors; let i = index">
                <td class="chk"><input title="Selecionar risco" type="checkbox" [id]="'risk_'+i" (change)="toggleRisk(rf,$event)" name="risks" [value]="rf" [checked]="selectedRisks.includes(rf)"></td>
                <td class="tipo">ERGON√îMICO</td>
                <td class="fator"><label [for]="'risk_'+i">{{rf}}</label></td>
              </tr>
            </tbody>
          </table>
        </div>
      </fieldset>

      <!-- Campos para registro da assinatura externa (opcionais) -->
      <fieldset class="aep-signature-fields">
        <div class="fields">
          <div class="field-row">
            <label for="fisioterapeutaSelect" class="field-label">Selecionar Fisioterapeuta:</label>
            <div class="field-input">
              <div class="physio-select-row">
                <select id="fisioterapeutaSelect" formControlName="fisioterapeutaId" class="form-select" title="Fisioterapeuta">
                  <option value="">{{ loadingPhysios ? 'Carregando...' : 'Selecione um fisioterapeuta...' }}</option>
                  <option *ngFor="let p of physiotherapists" [value]="p.id || p._id">{{ (p.name || p.nome) + ((p.crefito || p.CREFITO) ? (' | ' + (p.crefito || p.CREFITO)) : '') }}</option>
                </select>
                <button type="button" class="btn-secondary" (click)="creatingPhysio = !creatingPhysio">Novo</button>
              </div>
            </div>
          </div>

          <div class="physio-create-inline" *ngIf="creatingPhysio">
            <div class="field-row">
              <label class="field-label">Novo Fisioterapeuta:</label>
              <div class="field-input">
                <input class="form-control" [(ngModel)]="newPhysioName" [ngModelOptions]="{standalone: true}" placeholder="Nome" />
              </div>
            </div>
            <div class="field-row">
              <label class="field-label">CREFITO:</label>
              <div class="field-input">
                <input class="form-control" [(ngModel)]="newPhysioCrefito" [ngModelOptions]="{standalone: true}" placeholder="CREFITO" />
              </div>
            </div>
            <div class="field-row">
              <label class="field-label">&nbsp;</label>
              <div class="field-input physio-create-actions">
                <button type="button" class="btn-primary" (click)="createPhysiotherapist()">Salvar</button>
                <button type="button" class="btn-secondary" (click)="cancelCreatePhysio()">Cancelar</button>
              </div>
            </div>
          </div>

          <!-- Nome preenchido automaticamente a partir do select; campo de edi√ß√£o direto removido para evitar duplicidade -->
          <!-- Campo CREFITO removido conforme solicitado -->
        </div>
      </fieldset>

      <div class="aep-actions">
        <button type="submit" class="btn-primary">Emitir AEP</button>
        <button type="button" id="aepClear" class="btn-secondary" (click)="clear()">Limpar</button>
      </div>
      <div id="aepMsg" class="feedback" [ngClass]="{'success': msg.includes('‚úì'), 'error': msg.includes('‚úó'), 'warning': msg && !msg.includes('‚úì') && !msg.includes('‚úó')}">{{msg}}</div>
    </form>
  </div>
</section>